# DA-0001: SPAKE2+ Implementation Not Available

**Date:** 2025-12-20
**Status:** PENDING
**Component:** zp-crypto, zp-core (Task 4.1: Known Mode Handshake)
**Spec Section:** §4.3 (Known Mode), §4.3.4 (Known Mode Key Derivation), §4.1 (Connection Modes)
**Blocking:** YES - Blocks Task 4.1 implementation

## Question

The zp specification §4.3 mandates SPAKE2+ (RFC 9383) for Known Mode handshake, but no audited Rust implementation of SPAKE2+ exists. How should we proceed with Task 4.1 (Known Mode Handshake) given this critical dependency gap?

### Technical Context

**Spec Requirement (§4.3):**
- Known Mode uses SPAKE2+ password-authenticated key exchange
- Protocol flow: Client/Server exchange SPAKE2+ messages → derive spake2_key → encrypt ML-KEM exchange with spake2_key
- Key derivation: `session_secret = HKDF-SHA256(spake2_key || mlkem_shared, ...)`

**Available Rust Implementations:**

1. **spake2 crate** (RustCrypto/PAKEs)
   - Implements SPAKE2 (RFC 9382), NOT SPAKE2+ (RFC 9383)
   - Explicitly unaudited - documentation states "USE AT YOUR OWN RISK!"
   - SPAKE2 vs SPAKE2+: SPAKE2 is symmetric (both parties know password), SPAKE2+ is asymmetric (server stores derivative)
   - Source: https://github.com/RustCrypto/PAKEs/tree/master/spake2

2. **opaque-ke crate** (Facebook/Meta)
   - Implements OPAQUE (RFC 9807), a different PAKE protocol
   - Security audited by NCC Group (June 2021)
   - Would require spec change from SPAKE2+ to OPAQUE
   - Source: https://github.com/facebook/opaque-ke

3. **Other PAKEs** (AuCPace, CPace)
   - All unaudited, not SPAKE2+

**Security Requirements (CLAUDE.md Prime Directives):**
- "No Hallucination - Every implementation decision must trace to spec, test vectors, or DA ruling"
- "Implement crypto from scratch" is an anti-pattern
- All crypto must use audited crates

## Options Considered

### Option 1: Use unaudited spake2 crate (SPAKE2, not SPAKE2+)

**Pros:**
- Available now in crates.io
- Maintained by RustCrypto organization
- Simpler than implementing from scratch

**Cons:**
- ❌ Implements SPAKE2 (RFC 9382), NOT SPAKE2+ (RFC 9383) - spec violation
- ❌ Never received security audit - documentation warns "USE AT YOUR OWN RISK"
- ❌ Violates CLAUDE.md requirement to use audited crypto crates
- ❌ SPAKE2 is symmetric (both parties know password), but §4.3 assumes asymmetric (server has derivative)
- ❌ High security risk for production deployment

**Effort:** 16-24 hours (integration + testing)
**Risk:** HIGH - Unaudited crypto in production

### Option 2: Change spec to use OPAQUE (RFC 9807)

**Pros:**
- ✅ opaque-ke crate is security audited by NCC Group (2021)
- ✅ Implements modern PAKE with strong security properties
- ✅ Actively maintained by Facebook/Meta
- ✅ RFC 9807 is a modern standard (2024)

**Cons:**
- Requires spec change (§4.3 rewrite)
- Protocol flow differs from current §4.3.1-4.3.4
- Test vectors in TEST_VECTORS.md §9.2 would need replacement
- May impact interoperability if other implementations follow current spec

**Effort:** 32-40 hours (spec rewrite + implementation + testing)
**Risk:** MEDIUM - Protocol change requires review

### Option 3: Defer Task 4.1 until audited SPAKE2+ available

**Pros:**
- ✅ No security compromise
- ✅ Spec remains unchanged
- Allows time for SPAKE2+ implementation to mature

**Cons:**
- Unknown timeline - no SPAKE2+ implementation in development
- Known Mode unavailable indefinitely
- Task 4.1 remains incomplete (P1 priority item)

**Effort:** 0 hours now, unknown future effort
**Risk:** LOW security risk, HIGH schedule risk

### Option 4: Implement SPAKE2+ from scratch and commission audit

**Pros:**
- ✅ Exact spec compliance (RFC 9383)
- ✅ Can be audited to zp requirements
- ✅ Could contribute to Rust crypto ecosystem

**Cons:**
- ❌ 40-60 hours development time (full SPAKE2+ implementation)
- ❌ Security audit costs ($15k-$30k estimated)
- ❌ Audit timeline: 4-8 weeks
- ❌ Violates "don't implement crypto from scratch" principle (until audited)
- ❌ Requires cryptography expertise beyond current project scope

**Effort:** 40-60 hours dev + $15k-$30k + 4-8 weeks audit
**Risk:** HIGH - Implementing crypto primitives is anti-pattern

### Option 5: Hybrid - Use SPAKE2 temporarily, plan OPAQUE migration

**Pros:**
- Allows Task 4.1 progress with caveat
- Clear migration path to audited solution
- Could implement both modes (SPAKE2 deprecated, OPAQUE recommended)

**Cons:**
- Still uses unaudited crypto temporarily
- Creates technical debt
- Requires two implementations (SPAKE2 + OPAQUE)

**Effort:** 16-24 hours (SPAKE2) + 32-40 hours (OPAQUE migration)
**Risk:** MEDIUM - Technical debt + temporary security compromise

## Recommendation

**Option 2 (Change spec to OPAQUE)** is recommended because:

1. **Security First:** opaque-ke has NCC Group security audit
2. **Modern Standard:** RFC 9807 (2024) is more recent than RFC 9383 (2023)
3. **Production Ready:** Used by Facebook/WhatsApp for E2E encrypted backups
4. **Reasonable Effort:** 32-40 hours for spec + implementation vs. indefinite wait

**Alternative:** If spec immutability is critical, **Option 3 (Defer)** until an audited SPAKE2+ implementation emerges.

**Not Recommended:** Options 1, 4, 5 involve unaudited crypto or excessive effort.

## DA Decision

**RESOLVED: 2025-12-20**
**Status:** APPROVED - Option 2 (Change spec to OPAQUE)
**Category:** B (Spec Gap - implementation ecosystem constraint)

### Finding

The DA correctly identified that:
1. Spec §4.3 mandates SPAKE2+ (RFC 9383)
2. No audited Rust SPAKE2+ implementation exists
3. The `spake2` crate implements RFC 9382 (SPAKE2), not RFC 9383 (SPAKE2+)

### Security Analysis

OPAQUE provides **strictly stronger** security properties than SPAKE2+:
- Server never learns password (only OPRF output)
- Same offline attack resistance and forward secrecy
- Mutual authentication preserved
- NCC Group audited (2021), production-tested by Meta/WhatsApp

### Decision

**APPROVED: Option 2 with conditions:**

1. **Cipher Suite Abstraction**: Define `ZP_PAKE_SUITE` parameter with OPAQUE as mandatory-to-implement default
2. **Frame Format Preservation**: Retain `KnownHello`, `KnownResponse`, `KnownFinish` frame names but update contents for OPAQUE flow
3. **Test Vector Replacement**: Replace TEST_VECTORS.md §9.2 with OPAQUE-based vectors
4. **Spec Version**: Mark as v1.1 candidate (significant change, not errata)

### Rationale

1. Security First: Using unaudited crypto is unacceptable
2. Equivalent Security: OPAQUE provides same/stronger properties
3. Pragmatic Path: opaque-ke is audited, maintained, production-ready
4. Ecosystem Reality: No timeline for audited SPAKE2+ implementation

### Spec Impact (v1.1)

- §4.3 rewrite (OPAQUE protocol flow)
- §4.3.4 Key Derivation update
- Appendix A: Add `ZP_PAKE_SUITE` parameter
- TEST_VECTORS.md §9.2 replacement

---

**Implementation Next Steps:**
1. ✅ Move DA-0001.md to docs/decisions/ (resolved)
2. Begin §4.3 rewrite draft (can parallel with implementation)
3. Implement OPAQUE integration using opaque-ke v3.0+
4. Generate new test vectors from opaque-ke conformance suite
5. Update NEXT_TASKS.md to reflect OPAQUE-based Task 4.1
